"""
–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
–°–æ–∑–¥–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã –∏ Excel-—Ñ–∞–π–ª—ã
"""

import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
from datetime import datetime
import os
import warnings
warnings.filterwarnings('ignore')

print("="*80)
print("–†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê –î–ê–ù–ù–´–•")
print("="*80)

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
script_dir = os.path.dirname(os.path.abspath(__file__))
data_path = os.path.join(script_dir, 'data.xlsx')
df = pd.read_excel(data_path)
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df['–ì–æ–¥'] = df['–î–∞—Ç–∞'].dt.year
df['–ú–µ—Å—è—Ü'] = df['–î–∞—Ç–∞'].dt.month
df['–ú–µ—Å—è—Ü_–Ω–∞–∑–≤–∞–Ω–∏–µ'] = df['–î–∞—Ç–∞'].dt.strftime('%Y-%m')
df['–ö–≤–∞—Ä—Ç–∞–ª'] = df['–î–∞—Ç–∞'].dt.to_period('Q').astype(str)

numeric_cols = df.select_dtypes(include=[np.number]).columns
df[numeric_cols] = df[numeric_cols].fillna(0)

# ============================================================================
# 1. –ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–û –ë–†–ï–ù–î–ê–ú
# ============================================================================

print("\n1. –ê–Ω–∞–ª–∏–∑ –ø–æ –±—Ä–µ–Ω–¥–∞–º...")
brand_analysis = df.groupby('Brand_format').agg({
    '–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±': 'sum',
    '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)': 'sum',
    '–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç': 'sum',
    '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —à—Ç.': 'sum',
    '–ø–ª–∞–Ω –∑–∞—Ç–∞—Ä—Ç—ã': 'sum',
    '—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã': 'sum',
    '–¥–æ—Ö–æ–¥ –ø–ª–∞–Ω': 'sum',
    '–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç': 'sum',
    '–ö–æ–Ω—Ç—Ä–∞–∫—Ç': 'count'
}).round(2)

brand_analysis.columns = ['–ü–ª–∞–Ω_—Ä—É–±', '–§–∞–∫—Ç_—Ä—É–±', '–ü–ª–∞–Ω_—à—Ç', '–§–∞–∫—Ç_—à—Ç', 
                           '–ü–ª–∞–Ω_–∑–∞—Ç—Ä–∞—Ç—ã', '–§–∞–∫—Ç_–∑–∞—Ç—Ä–∞—Ç—ã', '–ü–ª–∞–Ω_–¥–æ—Ö–æ–¥', 
                           '–§–∞–∫—Ç_–¥–æ—Ö–æ–¥', '–ö–æ–ª_–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤']

brand_analysis['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_%'] = ((brand_analysis['–§–∞–∫—Ç_—Ä—É–±'] / 
                                    brand_analysis['–ü–ª–∞–Ω_—Ä—É–±'] * 100)
                                   .fillna(0).round(1))
brand_analysis['ROI_—Ñ–∞–∫—Ç_%'] = ((brand_analysis['–§–∞–∫—Ç_–¥–æ—Ö–æ–¥'] / 
                                  brand_analysis['–§–∞–∫—Ç_–∑–∞—Ç—Ä–∞—Ç—ã'] * 100)
                                 .fillna(0).round(1))
brand_analysis['–ú–∞—Ä–∂–∞_—Ñ–∞–∫—Ç'] = (brand_analysis['–§–∞–∫—Ç_—Ä—É–±'] - 
                                 brand_analysis['–§–∞–∫—Ç_–∑–∞—Ç—Ä–∞—Ç—ã']).round(2)

brand_analysis = brand_analysis.sort_values('–§–∞–∫—Ç_—Ä—É–±', ascending=False)

# ============================================================================
# 2. –ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–û –°–ï–¢–Ø–ú (–¢–û–ü-20)
# ============================================================================

print("2. –ê–Ω–∞–ª–∏–∑ –ø–æ —Å–µ—Ç—è–º (–¢–û–ü-20)...")
network_analysis = df.groupby('–°–µ—Ç—å').agg({
    '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)': 'sum',
    '–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±': 'sum',
    '—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã': 'sum',
    '–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç': 'sum',
    '–ö–æ–Ω—Ç—Ä–∞–∫—Ç': 'nunique'
}).round(2)

network_analysis.columns = ['–§–∞–∫—Ç_–ø—Ä–æ–¥–∞–∂–∏', '–ü–ª–∞–Ω_–ø—Ä–æ–¥–∞–∂–∏', '–ó–∞—Ç—Ä–∞—Ç—ã', 
                             '–î–æ—Ö–æ–¥', '–ö–æ–ª_–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤']
network_analysis['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_%'] = ((network_analysis['–§–∞–∫—Ç_–ø—Ä–æ–¥–∞–∂–∏'] / 
                                      network_analysis['–ü–ª–∞–Ω_–ø—Ä–æ–¥–∞–∂–∏'] * 100)
                                     .fillna(0).round(1))
network_analysis['–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å_%'] = ((network_analysis['–î–æ—Ö–æ–¥'] / 
                                          network_analysis['–§–∞–∫—Ç_–ø—Ä–æ–¥–∞–∂–∏'] * 100)
                                         .fillna(0).round(1))

network_analysis = network_analysis.sort_values('–§–∞–∫—Ç_–ø—Ä–æ–¥–∞–∂–∏', ascending=False).head(20)

# ============================================================================
# 3. –¢–†–ï–ù–î –ê–ù–ê–õ–ò–ó –ü–û –ú–ï–°–Ø–¶–ê–ú
# ============================================================================

print("3. –¢—Ä–µ–Ω–¥ –∞–Ω–∞–ª–∏–∑...")
monthly_trend = df.groupby('–ú–µ—Å—è—Ü_–Ω–∞–∑–≤–∞–Ω–∏–µ').agg({
    '–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±': 'sum',
    '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)': 'sum',
    '–ø–ª–∞–Ω –∑–∞—Ç–∞—Ä—Ç—ã': 'sum',
    '—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã': 'sum',
    '–¥–æ—Ö–æ–¥ –ø–ª–∞–Ω': 'sum',
    '–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç': 'sum',
    '–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç': 'sum',
    '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —à—Ç.': 'sum'
}).reset_index()

monthly_trend['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_–ø–ª–∞–Ω_%'] = ((monthly_trend['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'] / 
                                        monthly_trend['–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±'] * 100)
                                       .fillna(0).round(1))
monthly_trend['–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å_–∑–∞—Ç—Ä–∞—Ç'] = ((monthly_trend['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'] / 
                                           monthly_trend['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'])
                                          .fillna(0).round(2))
monthly_trend['ROI_%'] = ((monthly_trend['–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç'] / 
                           monthly_trend['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'] * 100)
                          .fillna(0).round(1))

# ============================================================================
# 4. –ö–í–ê–†–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó
# ============================================================================

print("4. –ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑...")
quarterly_analysis = df.groupby(['–ì–æ–¥', '–ö–≤–∞—Ä—Ç–∞–ª']).agg({
    '–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±': 'sum',
    '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)': 'sum',
    '–ø–ª–∞–Ω –∑–∞—Ç–∞—Ä—Ç—ã': 'sum',
    '—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã': 'sum',
    '–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç': 'sum'
}).reset_index()

quarterly_analysis['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_%'] = ((quarterly_analysis['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'] / 
                                        quarterly_analysis['–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±'] * 100)
                                       .fillna(0).round(1))
quarterly_analysis['ROI_%'] = ((quarterly_analysis['–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç'] / 
                                 quarterly_analysis['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'] * 100)
                                .fillna(0).round(1))

# ============================================================================
# 5. –ê–ù–ê–õ–ò–ó –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò –ó–ê–¢–†–ê–¢ –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú
# ============================================================================

print("5. –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞—Ç—Ä–∞—Ç...")

cost_categories_detail = {
    '–õ–∏—Å—Ç–∏–Ω–≥': ['–ü–ª–∞–Ω–æ–≤—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–õ–∏—Å—Ç–∏–Ω–≥/–±–µ–∑—É—Å–ª–æ–≤–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã¬ª, —Ä—É–±', 
                '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–õ–∏—Å—Ç–∏–Ω–≥/–±–µ–∑—É—Å–ª–æ–≤–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã¬ª, —Ä—É–±'],
    '–°–∫–∏–¥–∫–∞_–≤_—Ü–µ–Ω–µ': ['–ü–ª–∞–Ω–æ–≤—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–°–∫–∏–¥–∫–∞ –≤ —Ü–µ–Ω–µ¬ª, —Ä—É–±', 
                       '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–°–∫–∏–¥–∫–∞ –≤ —Ü–µ–Ω–µ¬ª, —Ä—É–±'],
    '–†–µ—Ç—Ä–æ': ['–ü–ª–∞–Ω–æ–≤—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–†–µ—Ç—Ä–æ¬ª, —Ä—É–±', 
              '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–†–µ—Ç—Ä–æ¬ª, —Ä—É–±'],
    '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥': ['–ü–ª–∞–Ω–æ–≤—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥¬ª, —Ä—É–±', 
                  '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥¬ª, —Ä—É–±'],
    '–ü—Ä–æ–º–æ_—Å–∫–∏–¥–∫–∞': ['–ü–ª–∞–Ω–æ–≤—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–ü—Ä–æ–º–æ-—Å–∫–∏–¥–∫–∞¬ª, —Ä—É–±', 
                     '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã ¬´–ü—Ä–æ–º–æ-—Å–∫–∏–¥–∫–∞¬ª, —Ä—É–±']
}

cost_efficiency = []
for category, cols in cost_categories_detail.items():
    plan_cost = df[cols[0]].sum()
    fact_cost = df[cols[1]].sum()
    fact_sales = df['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'].sum()
    
    cost_efficiency.append({
        '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': category,
        '–ü–ª–∞–Ω_–∑–∞—Ç—Ä–∞—Ç—ã': round(plan_cost, 2),
        '–§–∞–∫—Ç_–∑–∞—Ç—Ä–∞—Ç—ã': round(fact_cost, 2),
        '–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ': round(fact_cost - plan_cost, 2),
        '–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ_%': round((fact_cost - plan_cost) / plan_cost * 100 if plan_cost > 0 else 0, 1),
        '–î–æ–ª—è_–≤_–∑–∞—Ç—Ä–∞—Ç–∞—Ö_%': round(fact_cost / df['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'].sum() * 100 if df['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'].sum() > 0 else 0, 1),
        '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å_(—Ä—É–±_–ø—Ä–æ–¥–∞–∂_–Ω–∞_1_—Ä—É–±_–∑–∞—Ç—Ä–∞—Ç)': round(fact_sales / fact_cost if fact_cost > 0 else 0, 2)
    })

cost_efficiency_df = pd.DataFrame(cost_efficiency)

# ============================================================================
# 6. –ê–ù–ê–õ–ò–ó –ü–û –ì–†–£–ü–ü–ê–ú –°–ë–´–¢–ê –° –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ï–ô
# ============================================================================

print("6. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –≥—Ä—É–ø–ø–∞–º —Å–±—ã—Ç–∞...")
group_detail = df.groupby(['–≥—Ä—É–ø–ø–∞ —Å–±—ã—Ç–∞', '–ú–µ—Å—è—Ü_–Ω–∞–∑–≤–∞–Ω–∏–µ']).agg({
    '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)': 'sum',
    '–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±': 'sum',
    '—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã': 'sum',
    '–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç': 'sum'
}).reset_index()

group_detail['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_%'] = ((group_detail['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'] / 
                                  group_detail['–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±'] * 100)
                                 .fillna(0).round(1))

# ============================================================================
# –≠–ö–°–ü–û–†–¢ –í EXCEL
# ============================================================================

print("\n7. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel...")
output_excel = os.path.join(script_dir, 'analytics_report.xlsx')

with pd.ExcelWriter(output_excel, engine='openpyxl') as writer:
    # –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    summary_data = {
        '–ú–µ—Ç—Ä–∏–∫–∞': [
            '–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞',
            '–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π',
            '–ü–ª–∞–Ω –ø—Ä–æ–¥–∞–∂ (—Ä—É–±)',
            '–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂ (—Ä—É–±)',
            '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ (%)',
            '–ü–ª–∞–Ω –∑–∞—Ç—Ä–∞—Ç (—Ä—É–±)',
            '–§–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç (—Ä—É–±)',
            '–ü–ª–∞–Ω –¥–æ—Ö–æ–¥–∞ (—Ä—É–±)',
            '–§–∞–∫—Ç –¥–æ—Ö–æ–¥–∞ (—Ä—É–±)',
            'ROI —Ñ–∞–∫—Ç (%)',
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤',
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ç–µ–π',
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–µ–Ω–¥–æ–≤'
        ],
        '–ó–Ω–∞—á–µ–Ω–∏–µ': [
            f"{df['–î–∞—Ç–∞'].min().strftime('%Y-%m-%d')} - {df['–î–∞—Ç–∞'].max().strftime('%Y-%m-%d')}",
            len(df),
            round(df['–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±'].sum(), 2),
            round(df['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'].sum(), 2),
            round(df['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'].sum() / df['–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±'].sum() * 100, 2),
            round(df['–ø–ª–∞–Ω –∑–∞—Ç–∞—Ä—Ç—ã'].sum(), 2),
            round(df['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'].sum(), 2),
            round(df['–¥–æ—Ö–æ–¥ –ø–ª–∞–Ω'].sum(), 2),
            round(df['–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç'].sum(), 2),
            round(df['–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç'].sum() / df['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'].sum() * 100, 2),
            df['–ö–æ–Ω—Ç—Ä–∞–∫—Ç'].nunique(),
            df['–°–µ—Ç—å'].nunique(),
            df['Brand_format'].nunique()
        ]
    }
    pd.DataFrame(summary_data).to_excel(writer, sheet_name='–°–≤–æ–¥–∫–∞', index=False)
    
    # –ê–Ω–∞–ª–∏–∑ –ø–æ –±—Ä–µ–Ω–¥–∞–º
    brand_analysis.to_excel(writer, sheet_name='–ê–Ω–∞–ª–∏–∑ –ø–æ –±—Ä–µ–Ω–¥–∞–º')
    
    # –ê–Ω–∞–ª–∏–∑ –ø–æ —Å–µ—Ç—è–º
    network_analysis.to_excel(writer, sheet_name='–¢–û–ü-20 —Å–µ—Ç–µ–π')
    
    # –ú–µ—Å—è—á–Ω—ã–π —Ç—Ä–µ–Ω–¥
    monthly_trend.to_excel(writer, sheet_name='–¢—Ä–µ–Ω–¥ –ø–æ –º–µ—Å—è—Ü–∞–º', index=False)
    
    # –ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    quarterly_analysis.to_excel(writer, sheet_name='–ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑', index=False)
    
    # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—Ç—Ä–∞—Ç
    cost_efficiency_df.to_excel(writer, sheet_name='–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—Ç—Ä–∞—Ç', index=False)
    
    # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≥—Ä—É–ø–ø–∞–º —Å–±—ã—Ç–∞
    group_detail.to_excel(writer, sheet_name='–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≥—Ä—É–ø–ø–∞–º', index=False)

# ============================================================================
# –°–û–ó–î–ê–ù–ò–ï –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ô
# ============================================================================

print("\n8. –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π...")

# –ì—Ä–∞—Ñ–∏–∫ 1: –î–∏–Ω–∞–º–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –∏ ROI
fig1 = make_subplots(
    rows=2, cols=1,
    subplot_titles=('–î–∏–Ω–∞–º–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –ø—Ä–æ–¥–∞–∂', '–î–∏–Ω–∞–º–∏–∫–∞ ROI'),
    vertical_spacing=0.15
)

fig1.add_trace(
    go.Scatter(x=monthly_trend['–ú–µ—Å—è—Ü_–Ω–∞–∑–≤–∞–Ω–∏–µ'], 
               y=monthly_trend['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_–ø–ª–∞–Ω_%'],
               mode='lines+markers',
               name='–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞',
               line=dict(width=3, color='#3498db'),
               marker=dict(size=10)),
    row=1, col=1
)
fig1.add_hline(y=100, line_dash="dash", line_color="red", 
               annotation_text="–¶–µ–ª–µ–≤–æ–π –ø–ª–∞–Ω", row=1, col=1)

fig1.add_trace(
    go.Scatter(x=monthly_trend['–ú–µ—Å—è—Ü_–Ω–∞–∑–≤–∞–Ω–∏–µ'], 
               y=monthly_trend['ROI_%'],
               mode='lines+markers',
               name='ROI',
               line=dict(width=3, color='#2ecc71'),
               marker=dict(size=10),
               showlegend=False),
    row=2, col=1
)

fig1.update_xaxes(tickangle=45)
fig1.update_layout(height=700, title_text="<b>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</b>",
                   template='plotly_white')
fig1.update_yaxes(title_text="–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, %", row=1, col=1)
fig1.update_yaxes(title_text="ROI, %", row=2, col=1)

# –ì—Ä–∞—Ñ–∏–∫ 2: –¢–æ–ø –±—Ä–µ–Ω–¥—ã
top_brands = brand_analysis.head(15)
fig2 = go.Figure()
fig2.add_trace(go.Bar(
    y=top_brands.index,
    x=top_brands['–§–∞–∫—Ç_—Ä—É–±'],
    orientation='h',
    marker=dict(color=top_brands['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_%'], 
                colorscale='RdYlGn',
                showscale=True,
                colorbar=dict(title="–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, %")),
    text=top_brands['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_%'].apply(lambda x: f'{x:.1f}%'),
    textposition='outside'
))
fig2.update_layout(
    title='<b>–¢–û–ü-15 –±—Ä–µ–Ω–¥–æ–≤ –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–¥–∞–∂–∞–º</b>',
    xaxis_title='–ü—Ä–æ–¥–∞–∂–∏, —Ä—É–±',
    yaxis_title='–ë—Ä–µ–Ω–¥',
    height=600,
    template='plotly_white'
)

# –ì—Ä–∞—Ñ–∏–∫ 3: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—Ç—Ä–∞—Ç
fig3 = go.Figure()
fig3.add_trace(go.Scatter(
    x=cost_efficiency_df['–§–∞–∫—Ç_–∑–∞—Ç—Ä–∞—Ç—ã'],
    y=cost_efficiency_df['–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å_(—Ä—É–±_–ø—Ä–æ–¥–∞–∂_–Ω–∞_1_—Ä—É–±_–∑–∞—Ç—Ä–∞—Ç)'],
    mode='markers+text',
    marker=dict(size=20, color=cost_efficiency_df['–î–æ–ª—è_–≤_–∑–∞—Ç—Ä–∞—Ç–∞—Ö_%'],
                colorscale='Viridis', showscale=True,
                colorbar=dict(title="–î–æ–ª—è –≤ –∑–∞—Ç—Ä–∞—Ç–∞—Ö, %")),
    text=cost_efficiency_df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'],
    textposition='top center'
))
fig3.update_layout(
    title='<b>–ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞—Ç—Ä–∞—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</b>',
    xaxis_title='–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã, —Ä—É–±',
    yaxis_title='–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (—Ä—É–± –ø—Ä–æ–¥–∞–∂ / —Ä—É–± –∑–∞—Ç—Ä–∞—Ç)',
    height=500,
    template='plotly_white'
)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
additional_html = f"""
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <style>
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }}
        .container {{
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }}
        h1 {{
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }}
        .chart-container {{
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
        
        <div class="chart-container">
            {fig1.to_html(full_html=False, include_plotlyjs='cdn')}
        </div>
        
        <div class="chart-container">
            {fig2.to_html(full_html=False, include_plotlyjs=False)}
        </div>
        
        <div class="chart-container">
            {fig3.to_html(full_html=False, include_plotlyjs=False)}
        </div>
        
        <div style="text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; color: #7f8c8d;">
            <p>üìÖ –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}</p>
        </div>
    </div>
</body>
</html>
"""

html_output = os.path.join(script_dir, 'advanced_analytics_report.html')
with open(html_output, 'w', encoding='utf-8') as f:
    f.write(additional_html)

# ============================================================================
# –í–´–í–û–î –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# ============================================================================

print("\n" + "="*80)
print("‚úÖ –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê")
print("="*80)

print("\nüìä –û–°–ù–û–í–ù–´–ï –í–´–í–û–î–´:")
print(f"  ‚Ä¢ –û–±—â–∏–π –ø–ª–∞–Ω –ø—Ä–æ–¥–∞–∂: {df['–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±'].sum():,.0f} —Ä—É–±")
print(f"  ‚Ä¢ –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏: {df['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'].sum():,.0f} —Ä—É–±")
print(f"  ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞: {df['–§–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–± (–æ—Ç –¶–ú)'].sum() / df['–ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —Ä—É–±'].sum() * 100:.1f}%")
print(f"  ‚Ä¢ ROI —Ñ–∞–∫—Ç: {df['–¥–æ—Ö–æ–¥ —Ñ–∞–∫—Ç'].sum() / df['—Ñ–∞–∫—Ç –∑–∞—Ç—Ä–∞—Ç—ã'].sum() * 100:.1f}%")
print(f"  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–µ–Ω–¥–æ–≤: {df['Brand_format'].nunique()}")
print(f"  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ç–µ–π: {df['–°–µ—Ç—å'].nunique()}")
print(f"  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: {df['–ö–æ–Ω—Ç—Ä–∞–∫—Ç'].nunique()}")

print("\nüìÅ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´:")
print(f"  1. {output_excel}")
print(f"     - 7 –≤–∫–ª–∞–¥–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º")
print(f"  2. {html_output}")
print(f"     - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏")

print("\nüîç –¢–û–ü-5 –ë–†–ï–ù–î–û–í –ü–û –ü–†–û–î–ê–ñ–ê–ú:")
for i, (brand, row) in enumerate(brand_analysis.head(5).iterrows(), 1):
    print(f"  {i}. {brand}: {row['–§–∞–∫—Ç_—Ä—É–±']:,.0f} —Ä—É–± ({row['–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ_%']:.1f}% –ø–ª–∞–Ω–∞)")

print("\nüí∞ –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ó–ê–¢–†–ê–¢:")
for _, row in cost_efficiency_df.iterrows():
    print(f"  ‚Ä¢ {row['–ö–∞—Ç–µ–≥–æ—Ä–∏—è']}: {row['–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å_(—Ä—É–±_–ø—Ä–æ–¥–∞–∂_–Ω–∞_1_—Ä—É–±_–∑–∞—Ç—Ä–∞—Ç)']:.2f} —Ä—É–± –ø—Ä–æ–¥–∞–∂ –Ω–∞ 1 —Ä—É–± –∑–∞—Ç—Ä–∞—Ç")

print("\n" + "="*80)
print("üéâ –í—Å–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã –≥–æ—Ç–æ–≤—ã!")
print("="*80)
